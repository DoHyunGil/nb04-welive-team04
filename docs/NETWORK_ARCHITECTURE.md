# 네트워크 아키텍처 및 보안 그룹 설정 가이드

## 전체 네트워크 흐름도

```
┌─────────────────────────────────────────────────────────────────┐
│                         인터넷 (사용자)                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   Port 80/443   │  HTTP/HTTPS
                    └─────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                          EC2 인스턴스                             │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                 보안 그룹: welive-backend-sg                │  │
│  │                                                            │  │
│  │  인바운드:                                                  │  │
│  │  ✓ SSH (22) ← 개발자 IP만                                 │  │
│  │  ✓ HTTP (80) ← 0.0.0.0/0 (모든 사용자)                    │  │
│  │  ✓ HTTPS (443) ← 0.0.0.0/0 (모든 사용자)                  │  │
│  │  ✓ TCP (4000) ← 0.0.0.0/0 (선택사항)                      │  │
│  │                                                            │  │
│  │  아웃바운드:                                                │  │
│  │  ✓ All traffic → 0.0.0.0/0                               │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────┐         ┌──────────────────┐                      │
│  │  Nginx   │ :80 →   │  Docker Container│                      │
│  │  (리버스  │         │  (Node.js App)   │                      │
│  │  프록시)  │         │    Port 4000     │                      │
│  └──────────┘         └──────────────────┘                      │
│                              │                                   │
└──────────────────────────────┼───────────────────────────────────┘
                              │
                              │ (아웃바운드)
         ┌────────────────────┼────────────────────┐
         │                    │                    │
         ▼                    ▼                    ▼
   ┌─────────┐         ┌─────────┐         ┌─────────┐
   │   RDS   │         │   ECR   │         │   S3    │
   │  :5432  │         │ (이미지) │         │ (파일)  │
   └─────────┘         └─────────┘         └─────────┘
        │
        │
   ┌────────────────────────────────────┐
   │   RDS 보안 그룹                     │
   │   인바운드:                         │
   │   ✓ PostgreSQL (5432)              │
   │     ← welive-backend-sg만          │
   └────────────────────────────────────┘
```

## 상세 트래픽 흐름

### 1. 사용자 → 백엔드 API 호출

```
사용자 브라우저
    │
    │ HTTPS (443)
    ▼
EC2 퍼블릭 IP (인바운드: 포트 443 허용)
    │
    │ 보안 그룹 welive-backend-sg 통과
    ▼
Nginx (EC2 내부, 포트 80/443 리스닝)
    │
    │ 리버스 프록시 (내부 전달)
    ▼
Docker 컨테이너 (EC2 내부, 포트 4000)
    │
    ▼
Node.js 애플리케이션
```

### 2. 백엔드 → 데이터베이스 연결

```
Docker 컨테이너 (EC2 내부, ap-northeast-2)
    │
    │ 아웃바운드: 모든 트래픽 허용
    ▼
EC2 보안 그룹 welive-backend-sg (출발, sg-0f4095cd3144a9cf0)
    │
    │ PostgreSQL (5432) - 같은 리전 내 통신
    ▼
RDS 보안 그룹 (인바운드 규칙 검사, ap-northeast-2)
    │
    │ ✓ 소스가 sg-0f4095cd3144a9cf0인가? → YES
    ▼
RDS PostgreSQL (새로운_엔드포인트.ap-northeast-2.rds.amazonaws.com)
```

> ⚠️ **중요**: EC2와 RDS가 **같은 리전(ap-northeast-2)**에 있어야 보안 그룹 연결 가능!

### 3. 개발자 → EC2 SSH 접속

```
개발자 로컬 PC (예: 123.456.789.0)
    │
    │ SSH (22)
    ▼
EC2 퍼블릭 IP
    │
    │ 보안 그룹 인바운드 규칙 검사
    │ ✓ SSH (22), 소스 IP가 123.456.789.0인가? → YES
    ▼
EC2 인스턴스 SSH 접속 성공
```

### 4. GitHub Actions → ECR → EC2 배포

```
GitHub Actions Runner
    │
    │ 1. Docker 이미지 빌드
    ▼
    │ 2. ECR 푸시 (AWS 자격 증명 사용)
    ▼
ECR (746387398820.dkr.ecr.ap-northeast-2.amazonaws.com/welive)
    │
    │ 3. GitHub Actions가 EC2에 SSH 접속
    ▼
EC2 인스턴스
    │
    │ 4. ECR 로그인 (AWS CLI)
    │ 5. Docker Pull (아웃바운드: ECR 접근)
    ▼
Docker 컨테이너 실행 (최신 이미지)
```

### 5. 백엔드 → S3 파일 업로드

```
Node.js 애플리케이션 (파일 업로드 요청)
    │
    │ AWS SDK (S3 putObject)
    ▼
EC2 아웃바운드 (모든 트래픽 허용)
    │
    │ HTTPS (443)
    ▼
S3 (nb04-welive-team04)
```

## 보안 그룹 설정 상세

### EC2 보안 그룹 (welive-backend-sg)

#### 인바운드 규칙

| 규칙 ID | 유형 | 프로토콜 | 포트 | 소스 | 설명 |
|--------|------|---------|------|------|------|
| 1 | SSH | TCP | 22 | **개발자 IP/32** | 개발자만 SSH 접속 가능 |
| 2 | HTTP | TCP | 80 | 0.0.0.0/0 | 모든 사용자 HTTP 접근 |
| 3 | HTTPS | TCP | 443 | 0.0.0.0/0 | 모든 사용자 HTTPS 접근 |
| 4 | Custom TCP | TCP | 4000 | 0.0.0.0/0 | 직접 앱 포트 접근 (선택) |

**각 규칙 설명**:

1. **SSH (22)**:
   - **소스**: `123.456.789.0/32` (본인 공인 IP)
   - **용도**: EC2 서버 관리 (터미널 접속)
   - **보안**: 반드시 본인 IP만 허용 (0.0.0.0/0은 위험!)
   - **확인 방법**: https://www.whatismyip.com/

2. **HTTP (80)**:
   - **소스**: `0.0.0.0/0` (모든 IP)
   - **용도**: 사용자가 웹 브라우저로 API 호출
   - **흐름**: 사용자 → Nginx → Docker (4000)

3. **HTTPS (443)**:
   - **소스**: `0.0.0.0/0` (모든 IP)
   - **용도**: SSL 인증서 적용 시 보안 통신
   - **필수**: 프로덕션 환경에서는 필수

4. **Custom TCP (4000)**:
   - **소스**: `0.0.0.0/0` (모든 IP)
   - **용도**: Nginx 없이 직접 앱에 접근 (테스트용)
   - **선택사항**: Nginx를 사용한다면 제거 가능

#### 아웃바운드 규칙

| 유형 | 프로토콜 | 포트 범위 | 대상 | 설명 |
|------|---------|----------|------|------|
| All traffic | All | All | 0.0.0.0/0 | EC2가 외부와 통신 |

**아웃바운드 트래픽 예시**:
- EC2 → RDS (5432)
- EC2 → ECR (이미지 pull)
- EC2 → S3 (파일 업로드)
- EC2 → 인터넷 (npm install, apt-get 등)

### RDS 보안 그룹

#### 인바운드 규칙

| 유형 | 프로토콜 | 포트 | 소스 | 설명 |
|------|---------|------|------|------|
| PostgreSQL | TCP | 5432 | **sg-xxxx** (welive-backend-sg) | EC2에서만 접근 가능 |

**중요 포인트**:
- 소스는 **IP가 아닌 보안 그룹 ID**를 사용
- EC2 보안 그룹 ID 예: `sg-0123456789abcdef0`
- 이렇게 하면 EC2 IP가 변경되어도 자동으로 연결 유지
- 외부 인터넷에서는 RDS 직접 접근 불가 (보안)

#### 아웃바운드 규칙

기본값 유지 (변경 불필요)

## 포트 정리

| 포트 | 서비스 | 위치 | 외부 접근 |
|------|--------|------|----------|
| 22 | SSH | EC2 | ✓ (개발자 IP만) |
| 80 | Nginx HTTP | EC2 | ✓ (모든 IP) |
| 443 | Nginx HTTPS | EC2 | ✓ (모든 IP) |
| 4000 | Node.js App | EC2 내부 Docker | ✓ (선택사항) |
| 5432 | PostgreSQL | RDS | ✗ (EC2만) |

## 실제 설정 예시

### EC2 보안 그룹 생성 (AWS Console)

1. **EC2 → 보안 그룹 → 보안 그룹 생성**

2. **기본 세부 정보**:
   ```
   보안 그룹 이름: welive-backend-sg
   설명: WeLive Backend Security Group
   VPC: (기본 VPC 선택)
   ```

3. **인바운드 규칙 추가**:

   첫 번째 규칙:
   ```
   유형: SSH
   프로토콜: TCP
   포트 범위: 22
   소스: 내 IP (자동 감지) 또는 123.456.789.0/32
   설명: Developer SSH access
   ```

   두 번째 규칙:
   ```
   유형: HTTP
   프로토콜: TCP
   포트 범위: 80
   소스: 0.0.0.0/0
   설명: Public HTTP access
   ```

   세 번째 규칙:
   ```
   유형: HTTPS
   프로토콜: TCP
   포트 범위: 443
   소스: 0.0.0.0/0
   설명: Public HTTPS access
   ```

   네 번째 규칙 (선택사항):
   ```
   유형: 사용자 지정 TCP
   프로토콜: TCP
   포트 범위: 4000
   소스: 0.0.0.0/0
   설명: Direct app access (optional)
   ```

4. **아웃바운드 규칙**: 기본값 유지 (All traffic → 0.0.0.0/0)

5. **생성** 클릭

### RDS 보안 그룹 수정

1. **RDS → 데이터베이스 → database-1 → 연결 & 보안**

2. **VPC 보안 그룹** 클릭 (예: default 또는 rds-sg-xxx)

3. **인바운드 규칙 편집**:
   ```
   유형: PostgreSQL
   프로토콜: TCP
   포트 범위: 5432
   소스: 사용자 지정 → welive-backend-sg (보안 그룹 ID 입력)
   설명: Allow from EC2
   ```

4. **규칙 저장**

## 테스트 방법

### 1. SSH 접속 테스트

```bash
ssh -i your-key.pem ubuntu@<EC2-PUBLIC-IP>
```

✓ 성공: 로그인 프롬프트 표시
✗ 실패: "Connection timed out" → 보안 그룹 SSH 규칙 확인

### 2. HTTP 접속 테스트

```bash
curl http://<EC2-PUBLIC-IP>/health
```

✓ 성공: 응답 반환
✗ 실패: "Connection refused" → 컨테이너 또는 Nginx 상태 확인

### 3. RDS 연결 테스트 (EC2 내부에서)

```bash
# EC2에 SSH 접속 후 (RDS 엔드포인트를 새로 받은 것으로 변경)
nc -zv 새로운_RDS_엔드포인트.ap-northeast-2.rds.amazonaws.com 5432
```

✓ 성공: "succeeded!"
✗ 실패: "Connection timed out" → RDS 보안 그룹 확인 또는 리전 확인

### 4. Docker 컨테이너 포트 확인

```bash
# EC2 내부에서
docker ps
sudo netstat -tlnp | grep 4000
```

✓ 성공: 4000 포트 LISTEN 상태
✗ 실패: 컨테이너 로그 확인

## 문제 해결

### "Connection timed out" (SSH)

- **원인**: SSH 인바운드 규칙 누락 또는 잘못된 소스 IP
- **해결**: EC2 보안 그룹에서 SSH (22) 규칙 확인
- **확인**: 본인 공인 IP가 소스에 포함되어 있는지

### "Connection refused" (HTTP)

- **원인**: Nginx 또는 Docker 컨테이너 미실행
- **해결**:
  ```bash
  sudo systemctl status nginx
  docker ps
  ```

### "Database connection failed"

- **원인 1**: RDS 보안 그룹에 EC2 보안 그룹 미등록
  - **해결**: RDS 인바운드 규칙에 `sg-0f4095cd3144a9cf0` 추가

- **원인 2**: RDS와 EC2가 다른 리전에 있음
  - **해결**: RDS를 ap-northeast-2로 이전 또는 재생성

- **테스트**: EC2에서 `nc -zv <RDS-ENDPOINT> 5432`

## 보안 권장사항

1. **SSH는 반드시 특정 IP만 허용**
   - ✗ 나쁜 예: 0.0.0.0/0
   - ✓ 좋은 예: 123.456.789.0/32

2. **RDS는 절대 외부 노출 금지**
   - ✓ EC2 보안 그룹만 허용
   - ✗ 0.0.0.0/0 절대 금지

3. **포트 4000은 테스트 후 제거 권장**
   - Nginx를 사용한다면 4000 직접 노출 불필요

4. **정기적인 보안 그룹 감사**
   - 불필요한 규칙 제거
   - 사용하지 않는 포트 닫기

## 요약

```
사용자 → [80/443] → EC2 (Nginx) → [4000] → Docker Container
                         ↓
                      [5432]
                         ↓
                       RDS
```

- **퍼블릭 접근**: 80, 443 (Nginx)
- **EC2 내부**: 4000 (Docker)
- **프라이빗**: 5432 (RDS, EC2만)
- **관리자**: 22 (SSH, 개발자 IP만)
